<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>OCR de Itens da Nota Fiscal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f9f9f9; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2, h3 { color: #333; }
        input[type="file"] { margin-bottom: 10px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 14px; word-wrap: break-word; }
        th:nth-child(1), td:nth-child(1) { width: 15%; } /* C√≥d */
        th:nth-child(2), td:nth-child(2) { width: 70%; } /* Descri√ß√£o */
        th:nth-child(3), td:nth-child(3) { width: 15%; } /* Quant. */
        th { background-color: #f2f2f2; }
        #status { margin-top: 15px; font-weight: bold; color: #555; }
        .button-group { margin-top: 15px; display: flex; gap: 10px; }
        button { padding: 10px 15px; border-radius: 5px; border: none; cursor: pointer; font-size: 14px; font-weight: bold; }
        #extractButton { background-color: #007bff; color: white; }
        #extractButton:disabled { background-color: #a0cfff; cursor: not-allowed; }
        #clearButton { background-color: #ffc107; color: black; }
        #exportButton { background-color: #28a745; color: white; }
        #exportButton:disabled { background-color: #94dcb1; cursor: not-allowed; }
        
        #previewContainer { margin-top: 20px; padding: 10px; border: 2px dashed #ccc; border-radius: 5px; min-height: 100px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        #previewContainer img, #previewContainer .pdf-icon { max-width: 100px; max-height: 100px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .preview-placeholder { color: #888; }

        #rawOutputContainer { margin-top: 20px; }
        #rawOutput { background-color: #272822; color: #f8f8f2; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìÑ Confer√™ncia de Itens de Nota Fiscal (PDF/Imagem)</h2>
    <p>Selecione arquivos no bot√£o abaixo ou simplesmente cole imagens na p√°gina (usando <strong>Ctrl + C</strong> e <strong>Ctrl + V</strong>).</p>
    <input type="file" id="fileInput" multiple accept=".pdf,image/png,image/jpeg,image/webp">
    <div id="previewContainer"><span class="preview-placeholder">Pr√©-visualiza√ß√£o das imagens e PDFs...</span></div>
    <div class="button-group">
        <button id="extractButton" disabled>üöÄ Extrair Texto das Imagens</button>
        <button id="clearButton">üóëÔ∏è Limpar Tudo</button>
        <button id="exportButton" onclick="exportCSV()" disabled>Exportar CSV</button>
    </div>
    <div id="status">Status: Aguardando imagens...</div>
    
    <table id="tabelaResultados">
        <thead>
            <tr>
                <th>C√ìD. PROD.</th>
                <th>DESCRI√á√ÉO</th>
                <th>QUANTIDADE</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="rawOutputContainer" style="display:none;">
        <h3>Texto Bruto Extra√≠do (para Diagn√≥stico)</h3>
        <pre id="rawOutput"></pre>
    </div>
</div>

<script>
    // ... (O c√≥digo anterior de manipula√ß√£o de eventos e arquivos permanece o mesmo) ...
    const fileInput = document.getElementById("fileInput");
    const previewContainer = document.getElementById("previewContainer");
    const previewPlaceholder = document.querySelector(".preview-placeholder");
    const extractButton = document.getElementById("extractButton");
    const clearButton = document.getElementById("clearButton");
    const exportButton = document.getElementById("exportButton");
    const tabelaBody = document.querySelector("#tabelaResultados tbody");
    const statusEl = document.getElementById("status");
    const rawOutputContainer = document.getElementById("rawOutputContainer");
    const rawOutput = document.getElementById("rawOutput");

    let arquivosParaProcessar = [];
    let produtosExtraidos = [];

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    window.addEventListener('paste', event => {
        const items = event.clipboardData.items;
        for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                const file = item.getAsFile();
                adicionarArquivoParaFila(file);
            }
        }
    });
    fileInput.addEventListener("change", event => {
        for (const file of event.target.files) { adicionarArquivoParaFila(file); }
        fileInput.value = ""; 
    });
    extractButton.addEventListener('click', iniciarProcessamento);
    clearButton.addEventListener('click', limparTudo);

    function adicionarArquivoParaFila(file) {
        if (!file) return;
        arquivosParaProcessar.push(file);
        const reader = new FileReader();
        reader.onload = (e) => {
            let previewElement;
            if (file.type.startsWith('image/')) {
                previewElement = document.createElement('img');
                previewElement.src = e.target.result;
            } else if (file.type === 'application/pdf') {
                previewElement = document.createElement('div');
                previewElement.textContent = 'üìÑ';
                previewElement.title = file.name;
                previewElement.className = 'pdf-icon';
                previewElement.style.fontSize = '5em';
            }
            if (previewElement) { previewContainer.appendChild(previewElement); }
        };
        reader.readAsDataURL(file);
        if (previewPlaceholder) { previewPlaceholder.style.display = 'none'; }
        atualizarEstadoBotoes();
    }

    async function iniciarProcessamento() {
        if (arquivosParaProcessar.length === 0) return;
        limparResultados();
        extractButton.disabled = true;
        statusEl.textContent = "Iniciando processamento...";
        rawOutputContainer.style.display = 'block';
        rawOutput.textContent = '';
        for (let i = 0; i < arquivosParaProcessar.length; i++) {
            const file = arquivosParaProcessar[i];
            const statusMsg = `(${i + 1}/${arquivosParaProcessar.length}) Processando: ${file.name}`;
            console.log(statusMsg);
            if (file.type === "application/pdf") { await processarPDF(file, i + 1); } 
            else if (file.type.startsWith("image/")) { await processarImagemDireta(file, i + 1); }
        }
        statusEl.textContent = `‚úÖ OCR conclu√≠do! ${produtosExtraidos.length} produtos encontrados.`;
        atualizarEstadoBotoes();
    }
    
    function limparTudo() {
        arquivosParaProcessar = [];
        limparResultados();
        previewContainer.innerHTML = '';
        if (previewPlaceholder) {
            previewContainer.appendChild(previewPlaceholder);
            previewPlaceholder.style.display = 'block';
        }
        statusEl.textContent = "Status: Aguardando imagens...";
        rawOutputContainer.style.display = 'none';
        rawOutput.textContent = '';
        atualizarEstadoBotoes();
    }
    
    function limparResultados() {
        produtosExtraidos = [];
        tabelaBody.innerHTML = "";
    }
    
    function atualizarEstadoBotoes() {
        extractButton.disabled = arquivosParaProcessar.length === 0;
        exportButton.disabled = produtosExtraidos.length === 0;
    }

    async function processarPDF(file, fileIndex) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            statusEl.textContent = `(${fileIndex}/${arquivosParaProcessar.length}) üìÑ Lendo p√°gina ${i}/${pdf.numPages}...`;
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.5 });
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            await fazerOCR(canvas.toDataURL("image/png"));
        }
    }

    async function processarImagemDireta(file, fileIndex) {
        statusEl.textContent = `(${fileIndex}/${arquivosParaProcessar.length}) üñºÔ∏è Lendo imagem: ${file.name}...`;
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        await fazerOCR(dataUrl);
    }

    async function fazerOCR(dataUrl) {
        statusEl.textContent = `${statusEl.textContent.split('...')[0]}... üß† Executando OCR...`;
        const result = await Tesseract.recognize(dataUrl, "por", {
            logger: m => console.log(m)
        });
        // ATUALIZA√á√ÉO: Mostra o texto bruto na tela
        rawOutput.textContent += result.data.text + '\n\n--- Fim da Imagem ---\n\n';
        processarTexto(result.data.text);
    }

    function processarTexto(texto) {
        const linhas = texto.split('\n');
        for (const linha of linhas) {
            // ETAPA 1: Regex flex√≠vel para capturar o m√≠nimo necess√°rio
            // Captura [1]c√≥digo no in√≠cio, [2]miolo, [3]quantidade no fim.
            const match = linha.match(/^(\d{5,})\s+(.*)\s+([\d,.]+)$/);

            if (match) {
                // ETAPA 2: Limpar o "miolo" capturado
                const codigo = match[1].trim();
                let descricaoBruta = match[2].trim();
                const quantidade = match[3].trim();
                
                // Remove as colunas indesejadas (NCM, CST, etc.) da descri√ß√£o
                // procurando pelo padr√£o de um c√≥digo NCM de 8 d√≠gitos.
                const ncmMatch = descricaoBruta.match(/\s\d{8}(\s|$)/);
                const descricaoLimpa = ncmMatch 
                    ? descricaoBruta.substring(0, ncmMatch.index).trim() 
                    : descricaoBruta;

                if (!produtosExtraidos.find(p => p.codigo === codigo)) {
                    produtosExtraidos.push({ codigo, descricao: descricaoLimpa, quantidade });

                    const row = tabelaBody.insertRow();
                    row.insertCell().textContent = codigo;
                    row.insertCell().textContent = descricaoLimpa;
                    row.insertCell().textContent = quantidade;
                }
            }
        }
    }

    function exportCSV() {
        if (produtosExtraidos.length === 0) {
            alert("Nenhum dado extra√≠do para exportar.");
            return;
        }
        let csv = "C√ìD. PROD.,DESCRI√á√ÉO,QUANTIDADE\n";
        produtosExtraidos.forEach(p => {
            const escapedDescricao = p.descricao.includes(',') ? `"${p.descricao}"` : p.descricao;
            csv += `${p.codigo},${escapedDescricao},${p.quantidade}\n`;
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "produtos-extraidos-ocr.csv";
        link.click();
        URL.revokeObjectURL(link.href);
    }
</script>

</body>
</html>