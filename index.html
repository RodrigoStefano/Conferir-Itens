<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Confer√™ncia de Itens de Nota Fiscal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body{font-family:Arial,sans-serif;padding:20px;background-color:#f0f2f5;color:#333;line-height:1.6;}
        .container{max-width:1200px;margin:30px auto;background:white;padding:30px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.08);border:1px solid #e0e0e0;}
        h2{color:#1a202c;margin-bottom:20px;font-size:2em;text-align:center;}
        h3{color:#333;margin-top:30px;border-bottom:2px solid #e2e8f0;padding-bottom:10px;}
        p{margin-bottom:15px;font-size:1.1em;color:#555;}
        input[type="file"], input[type="text"]{margin-bottom:15px;padding:10px;border:1px solid #ccc;border-radius:5px;background-color:#fafafa;font-size:1em;transition: border-color 0.3s ease;}
        table{border-collapse:collapse;width:100%;margin-top:20px;table-layout:fixed;box-shadow:0 2px 10px rgba(0,0,0,0.05);border-radius:8px;overflow:hidden;}
        th,td{border:1px solid #e2e8f0;padding:12px 15px;text-align:left;font-size:0.9em;word-wrap:break-word;transition: background-color 0.5s ease;}
        th{background-color:#edf2f7;color:#2d3748;font-weight:600;text-transform:uppercase;}
        tr:nth-child(even){background-color:#f7fafc;}
        tr:hover{background-color:#ebf8ff;}
        th:nth-child(1){width:12%;}
        th:nth-child(2){width:73%;}
        th:nth-child(3){width:15%;}
        #status{margin-top:20px;padding:10px;background-color:#e6f7ff;border:1px solid #b3e0ff;color:#006bbd;border-radius:6px;font-weight:bold;font-size:1.1em;text-align:center;}
        .button-group{margin-top:25px;display:flex;gap:15px;justify-content:center;}
        button{padding:12px 25px;border-radius:8px;border:none;cursor:pointer;font-size:1em;font-weight:bold;transition:all .2s ease-in-out;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
        #extractButton{background-color:#007bff;color:white;}
        #extractButton:hover:not(:disabled){background-color:#0056b3;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.15);}
        #extractButton:disabled{background-color:#a0cfff;cursor:not-allowed;opacity:.7;box-shadow:none;}
        #clearButton{background-color:#ffc107;color:#333;}
        #clearButton:hover{background-color:#e0a800;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.15);}
        #previewContainer{margin-top:20px;padding:15px;border:2px dashed #b0c4de;border-radius:10px;min-height:120px;display:flex;flex-wrap:wrap;gap:15px;align-items:center;justify-content:center;background-color:#fdfefe;}
        #previewContainer .pdf-icon,#previewContainer .xml-icon{max-width:100px;max-height:100px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);object-fit:contain;border:1px solid #ddd;}
        .preview-placeholder{color:#888;font-style:italic;font-size:1.1em;}
        .pdf-icon,.xml-icon{display:flex;align-items:center;justify-content:center;font-size:4.5em;width:100px;height:100px;background-color:#f0f4f7;color:#4a69bd;}
        .xml-icon{color:#228b22;}
        #scan-area { margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; }
        #scanInput { width: calc(100% - 24px); }

        /* --- NOVAS CLASSES PARA FEEDBACK VISUAL --- */
        .highlight-success {
            background-color: #d4edda !important; /* Verde claro */
        }
        .row-removing {
            background-color: #f8d7da !important; /* Vermelho claro */
            opacity: 0;
            transform: translateX(50px);
            transition: all 0.5s ease-out;
        }
        .input-success { outline-color: #28a745 !important; }
        .input-error { outline-color: #dc3545 !important; }

        /* --- NOVO ESTILO PARA FEEDBACK DE ERRO NO INPUT --- */
        #scanFeedback {
            font-size: 0.9em;
            font-weight: bold;
            height: 1.1em; /* Reserva espa√ßo para evitar que o layout mude */
            margin-top: -10px;
            margin-bottom: 10px;
            color: #dc3545; /* Vermelho */
        }

    </style>
</head>
<body>

<div class="container">
    <h2>üìÑ Confer√™ncia de Itens de Nota Fiscal</h2>
    <p>Selecione arquivos (**XML**) no bot√£o abaixo para processamento autom√°tico.</p>
    <input type="file" id="fileInput" multiple accept=".pdf,.xml">
    
    <div id="previewContainer"><span class="preview-placeholder">Pr√©-visualiza√ß√£o dos arquivos carregados...</span></div>
    <div class="button-group">
        <button id="extractButton">üöÄ Extrair Dados</button>
        <button id="clearButton">üóëÔ∏è Limpar Tudo</button>
    </div>
    <div id="status">Status: Aguardando arquivos para processar.</div>

    <div id="scan-area">
        <h3>Bipar / Digitar C√≥digo para Baixa</h3>
        <p>Digite o c√≥digo do produto e pressione <strong>Enter</strong> para dar baixa em uma unidade.</p>
        <input type="text" id="scanInput" placeholder="Aguardando c√≥digo do produto...">
        <p id="scanFeedback"></p> </div>
    
    <table id="tabelaResultados">
        <thead>
            <tr>
                <th>C√ìD. PROD.</th>
                <th>DESCRI√á√ÉO</th>
                <th>QUANTIDADE</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const fileInput=document.getElementById("fileInput"),previewContainer=document.getElementById("previewContainer"),previewPlaceholder=document.querySelector(".preview-placeholder"),extractButton=document.getElementById("extractButton"),clearButton=document.getElementById("clearButton"),tabelaBody=document.querySelector("#tabelaResultados tbody"),statusEl=document.getElementById("status"),scanInput=document.getElementById("scanInput"),scanFeedback=document.getElementById("scanFeedback"); // Refer√™ncia ao novo elemento
    let arquivosParaProcessar=[];
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    function playAudio(soundName) {
        const audio = new Audio(`public/sounds/${soundName}.mp3`);
        audio.play().catch(error => {
            console.error(`N√£o foi poss√≠vel tocar o √°udio '${soundName}':`, error);
        });
    }

    scanInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); 
            processarBaixaDeItem();
        }
    });

    function flashInput(inputElement, className) {
        inputElement.classList.add(className);
        setTimeout(() => {
            inputElement.classList.remove(className);
        }, 1000);
    }

    function processarBaixaDeItem() {
        scanFeedback.textContent = ''; // Limpa a mensagem anterior a cada nova leitura
        const rawCode = scanInput.value.trim();
        if (rawCode === '') return;

        let searchCode;
        if (rawCode.length > 5) {
            searchCode = rawCode.substring(rawCode.length - 6, rawCode.length - 1);
        } else {
            searchCode = rawCode;
        }

        const rows = tabelaBody.getElementsByTagName('tr');
        let produtoEncontrado = false;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const codeCell = row.cells[0];
            
            if (codeCell.textContent === searchCode) {
                produtoEncontrado = true;
                playAudio('success');
                const quantityCell = row.cells[2];
                let currentQuantity = parseFloat(quantityCell.textContent.replace(',', '.'));
                
                currentQuantity -= 1; 

                flashInput(scanInput, 'input-success');
                row.classList.add('highlight-success');
                setTimeout(() => {
                    row.classList.remove('highlight-success');
                }, 1000);

                if (currentQuantity <= 0) {
                    row.classList.add('row-removing');
                    setTimeout(() => row.remove(), 500);
                } else {
                    quantityCell.textContent = currentQuantity;
                }
                break; 
            }
        }

        if (!produtoEncontrado) {
            playAudio('error');
            flashInput(scanInput, 'input-error');
            // A LINHA DO ALERT FOI REMOVIDA DAQUI
            // E A L√ìGICA ABAIXO FOI ADICIONADA
            scanFeedback.textContent = `C√≥digo "${searchCode}" n√£o pertence a esta nota.`;
        }

        scanInput.value = ''; 
        scanInput.focus();
    }


    // --- FUN√á√ïES DE PROCESSAMENTO DE DADOS (XML/PDF) ---
    function processarDadosXML(xmlDoc) {
        const produtosAgregados = {};
        const produtosXML = xmlDoc.querySelectorAll('det > prod');
        if (produtosXML.length === 0) {
            statusEl.textContent += " (Nenhum produto encontrado na estrutura <det><prod> no XML)";
            return;
        }
        produtosXML.forEach(prod => {
            const codigo = prod.querySelector('cProd')?.textContent;
            if (!codigo) return; 
            const descricao = prod.querySelector('xProd')?.textContent || 'N/A';
            const quantidade = parseFloat(prod.querySelector('qCom')?.textContent || 0);
            if (produtosAgregados[codigo]) {
                produtosAgregados[codigo].quantidade += quantidade;
            } else {
                produtosAgregados[codigo] = { descricao: descricao, quantidade: quantidade };
            }
        });
        for (const codigo in produtosAgregados) {
            const produto = produtosAgregados[codigo];
            const row = tabelaBody.insertRow();
            row.insertCell().textContent = codigo;
            row.insertCell().textContent = produto.descricao;
            row.insertCell().textContent = produto.quantidade.toFixed(4).replace(/\.?0+$/, "");
        }
    }

    async function processarPDF(file, fileIndex) {
        statusEl.textContent = `(${fileIndex}/${arquivosParaProcessar.length}) üìÑ Lendo PDF: ${file.name}...`;
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            statusEl.textContent = `(${fileIndex}/${arquivosParaProcessar.length}) üìÑ Processando OCR na p√°gina ${i}/${pdf.numPages}...`;
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 3.0 });
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            const dataUrl = canvas.toDataURL("image/png");
            const result = await Tesseract.recognize(dataUrl, "por", { logger: m => console.log(m) });
            console.log(`Texto extra√≠do da p√°gina ${i}:`, result.data.text);
        }
    }
    
    async function processarXML(file, fileIndex) {
        statusEl.textContent = `(${fileIndex}/${arquivosParaProcessar.length}) üìä Lendo XML: ${file.name}...`;
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
                    processarDadosXML(xmlDoc);
                    resolve();
                } catch (error) {
                    console.error("Erro ao parsear XML:", error);
                    statusEl.textContent = `Erro ao processar XML: ${file.name}.`;
                    reject(error);
                }
            };
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }

    // --- FUN√á√ïES DE CONTROLE DA INTERFACE ---
    function limparResultados() {
        tabelaBody.innerHTML = "";
    }
    
    function atualizarEstadoBotoes() {
        extractButton.disabled = arquivosParaProcessar.length === 0;
    }

    function adicionarArquivoParaFila(file) {
        if (!file) return;
        const tiposAceitos = ['application/pdf', 'text/xml'];
        if (!tiposAceitos.includes(file.type) && !file.name.toLowerCase().endsWith('.xml')) {
            alert('Por favor, selecione apenas arquivos PDF ou XML.');
            return;
        }
        arquivosParaProcessar.push(file);
        let previewElement = document.createElement('div');
        previewElement.title = file.name;
        if (file.type === 'application/pdf') {
            previewElement.textContent = 'üìÑ';
            previewElement.className = 'pdf-icon';
        } else {
            previewElement.textContent = 'üìä';
            previewElement.className = 'xml-icon';
        }
        previewContainer.appendChild(previewElement);
        if (previewPlaceholder) { previewPlaceholder.style.display = 'none'; }
        atualizarEstadoBotoes();
    }
    
    async function iniciarProcessamento() {
        if (arquivosParaProcessar.length === 0) {
            statusEl.textContent = "Nenhum arquivo para processar.";
            return;
        }
        limparResultados();
        extractButton.disabled = true;
        statusEl.textContent = "Iniciando processamento...";
        for (let i = 0; i < arquivosParaProcessar.length; i++) {
            const file = arquivosParaProcessar[i];
            if (file.type === "application/pdf") {
                await processarPDF(file, i + 1);
            } else if (file.type === "text/xml" || file.name.toLowerCase().endsWith('.xml')) {
                await processarXML(file, i + 1);
            }
        }
        statusEl.textContent = `‚úÖ Processamento conclu√≠do! Total de ${tabelaBody.rows.length} produtos √∫nicos encontrados.`;
        atualizarEstadoBotoes();
    }

    function limparTudo() {
        arquivosParaProcessar = [];
        limparResultados();
        previewContainer.innerHTML = '';
        if (previewPlaceholder) {
            previewContainer.appendChild(previewPlaceholder);
            previewPlaceholder.style.display = 'block';
        }
        fileInput.value = "";
        statusEl.textContent = "Status: Aguardando arquivos para processar.";
        scanFeedback.textContent = "";
        atualizarEstadoBotoes();
    }

    fileInput.addEventListener("change", event => { for (const file of event.target.files) { adicionarArquivoParaFila(file); } });
    extractButton.addEventListener('click', iniciarProcessamento);
    clearButton.addEventListener('click', limparTudo);
    atualizarEstadoBotoes();
</script>

</body>
</html>